lzc-sdk-version: 0.1
name: rustfs
package: cloud.lazycat.app.sebastiaan.rustfs
version: 1.0.0
application:
  routes:
    - /=http://rustfs
  subdomain: rustfs
  background_task: true
  public_path:
    - /api/public
  ingress:
    # S3 API
    - protocol: tcp
      port: 9000
      service: rustfs
    # Console
    - protocol: tcp
      port: 9001
      service: rustfs
services:
  rustfs:
    restart: unless-stopped
    image: rustfs/rustfs:latest
    binds:
      - /lzcapp/var/data:/data
      - /lzcapp/var/app/logs:/app/logs
    environment:
      - RUSTFS_ACCESS_KEY={{ .RUSTFS_ACCESS_KEY }}
      - RUSTFS_SECRET_KEY={{ .RUSTFS_SECRET_KEY }}
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_SERVER_DOMAINS=${LAZYCAT_APP_DOMAIN}
      - RUSTFS_ADDRESS=:9000
    healthcheck:
      test:
        [
          "CMD",
          "sh", "-c",
          "curl -f http://rustfs:9000/health && curl -f http://rustfs:9001/rustfs/console/health"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  volume-permission-helper:
    image: alpine
    binds:
      - /lzcapp/var/data:/data
      - /lzcapp/var/app/logs:/app/logs
    command: >
      sh -c "
        chown -R 10001:10001 /data /app/logs &&
        echo 'Volume Permissions fixed' &&
        exit 0
      "
    restart: no
